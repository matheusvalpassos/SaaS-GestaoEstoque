{# backend/core/templates/reports/report_list.html #}
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Rede Bellas</title>
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'img/logos (8).png' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Estilos CSS para animações (consistência com outras páginas) */
        .fade-in-item {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-inter antialiased text-gray-800">
    {% include 'partials/_navbar.html' %}

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-extrabold text-[#DB0020] mb-8 text-center animate-pulse-once">
            {{ title }}
        </h1>

        {# BLOCO PARA EXIBIR MENSAGENS DO DJANGO #}
        {% if messages %}
            <div class="space-y-3 mb-6">
                {% for message in messages %}
                    <div class="p-4 rounded-lg shadow-md {% if message.tags == 'success' %}bg-green-100 text-green-800 border-l-4 border-green-500{% elif message.tags == 'error' %}bg-red-100 text-red-800 border-l-4 border-red-500{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500{% else %}bg-blue-100 text-blue-800 border-l-4 border-blue-500{% endif %} flex items-center transform transition-transform hover:scale-[1.01] animate-fade-in">
                        <svg class="w-5 h-5 mr-3 {% if message.tags == 'success' %}text-green-600{% elif message.tags == 'error' %}text-red-600{% elif message.tags == 'warning' %}text-yellow-600{% else %}text-blue-600{% endif %}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            {% if message.tags == 'success' %}
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            {% elif message.tags == 'error' %}
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            {% else %}
                                <path fill-rule="evenodd" d="M8.257 3.332a.995.995 0 011.486 0l3.054 5.09a1 1 0 01-.743 1.603H5.946a1 1 0 01-.743-1.603l3.054-5.09z" clip-rule="evenodd"></path>
                            {% endif %}
                        </svg>
                        <p class="text-sm font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto transform transition-all duration-300 hover:shadow-xl">
            {% if reports %}
                <div class="flex justify-end mb-4 space-x-4">
                    <button id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 opacity-50 cursor-not-allowed" disabled>
                        Excluir Selecionados
                    </button>
                    <button id="deleteAllBtn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                        Excluir Todos
                    </button>
                </div>

                <form id="reportDeleteForm" method="post" action="{% url 'report_delete_selected' %}">
                    {% csrf_token %}
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllCheckbox" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ID Relatório
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Gerado Em
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Código de Lote
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Filtros Aplicados
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for report in reports %}
                                <tr class="hover:bg-gray-50 transition-colors duration-200 fade-in-item" data-delay="{{ forloop.counter }}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <input type="checkbox" name="report_ids" value="{{ report.id }}" class="report-checkbox rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        {{ report.report_id }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ report.get_tipo_display }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ report.data_geracao|date:"d/m/Y H:i" }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ report.codigo_rastreamento_lote|default:"N/A" }}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis">
                                        {% if report.filtros_aplicados %}
                                            <div class="max-h-12 overflow-hidden text-ellipsis whitespace-normal">
                                                {% for key, value in report.filtros_aplicados.items %}
                                                    {% if value and value != 'Todos' and value != 'Qualquer' %}
                                                        <strong>{{ key|capfirst }}:</strong> {{ value }} <br>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            Nenhum
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        {# Link para Regenerar/Visualizar o PDF com os filtros originais #}
                                        <a href="{% url 'resgate_list' %}?format=pdf&codigo_rastreamento={{ report.codigo_rastreamento_lote|default:'' }}&posto={{ report.filtros_aplicados.posto|default:'' }}&produto={{ report.filtros_aplicados.produto|default:'' }}&data_geracao_inicio={{ report.filtros_aplicados.data_geracao_inicio|default:'' }}&data_geracao_fim={{ report.filtros_aplicados.data_geracao_fim|default:'' }}" 
                                           target="_blank" 
                                           class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg shadow-sm transition duration-300 text-xs transform hover:scale-105">
                                            Visualizar PDF
                                        </a>
                                        {# Botão para Excluir um único relatório #}
                                        <button type="button" onclick="confirmDeleteSingleReport('{{ report.id }}');" class="bg-red-400 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-lg shadow-sm transition duration-300 text-xs ml-2 transform hover:scale-105">
                                            Excluir
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form> {# Fim do formulário de exclusão #}
            {% else %}
                <p class="text-center text-gray-600 py-10 text-lg">
                    Nenhum relatório gerado ainda. 
                    <a href="{% url 'resgate_list' %}" class="text-[#DB0020] hover:underline hover:text-red-700 transition-colors duration-200">Gere seu primeiro relatório agora!</a>
                </p>
            {% endif %}
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Animação de fade-in para as linhas da tabela
            const tableRows = document.querySelectorAll('tbody tr');
            tableRows.forEach((row, index) => {
                const delay = parseFloat(row.dataset.delay) * 0.05; 
                row.style.animationDelay = `${delay}s`;
                row.classList.add('fade-in-item');
            });

            // Lógica de seleção e exclusão
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const reportCheckboxes = document.querySelectorAll('.report-checkbox');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            const reportDeleteForm = document.getElementById('reportDeleteForm');

            function updateDeleteSelectedButton() {
                const checkedCount = document.querySelectorAll('.report-checkbox:checked').length;
                if (checkedCount > 0) {
                    deleteSelectedBtn.disabled = false;
                    deleteSelectedBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    deleteSelectedBtn.disabled = true;
                    deleteSelectedBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            // Selecionar/desselecionar todos
            if (selectAllCheckbox) { // Garante que o checkbox exista antes de adicionar listener
                selectAllCheckbox.addEventListener('change', () => {
                    reportCheckboxes.forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                    });
                    updateDeleteSelectedButton();
                });
            }

            // Atualizar botão "Excluir Selecionados" ao clicar em checkboxes individuais
            reportCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (!checkbox.checked) {
                        selectAllCheckbox.checked = false;
                    } else {
                        const allChecked = Array.from(reportCheckboxes).every(cb => cb.checked);
                        selectAllCheckbox.checked = allChecked;
                    }
                    updateDeleteSelectedButton();
                });
            });

            // Ação do botão "Excluir Selecionados"
            if (deleteSelectedBtn) {
                deleteSelectedBtn.addEventListener('click', () => {
                    const selectedIds = Array.from(reportCheckboxes)
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => checkbox.value);

                    if (selectedIds.length > 0) {
                        if (confirm(`Tem certeza que deseja excluir os ${selectedIds.length} relatório(s) selecionado(s)?`)) {
                            reportDeleteForm.submit(); // Envia o formulário
                        }
                    } else {
                        alert('Por favor, selecione pelo menos um relatório para excluir.'); // Usando alert temporariamente
                    }
                });
            }

            // Ação do botão "Excluir Todos"
            if (deleteAllBtn) {
                deleteAllBtn.addEventListener('click', () => {
                    if (confirm('ATENÇÃO: Você está prestes a excluir TODOS os relatórios. Esta ação é IRREVERSÍVEL. Tem certeza que deseja continuar?')) {
                        // Cria um formulário temporário para a exclusão de todos
                        const tempForm = document.createElement('form');
                        tempForm.method = 'post';
                        tempForm.action = '{% url "report_delete_all" %}'; // URL para excluir todos
                        tempForm.style.display = 'none';

                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = '{{ csrf_token }}';
                        tempForm.appendChild(csrfInput);

                        document.body.appendChild(tempForm);
                        tempForm.submit();
                    }
                });
            }

            // Função para exclusão de um único relatório (chamada pelo onclick)
            window.confirmDeleteSingleReport = function(reportId) {
                if (confirm('Tem certeza que deseja excluir este relatório?')) {
                    // Cria um formulário temporário para a exclusão de um único item
                    const tempForm = document.createElement('form');
                    tempForm.method = 'post';
                    tempForm.action = `{% url "report_delete_single" 0 %}`.replace('0', reportId); // Substitui o PK placeholder
                    tempForm.style.display = 'none';

                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = '{{ csrf_token }}';
                    tempForm.appendChild(csrfInput);

                    document.body.appendChild(tempForm);
                    tempForm.submit();
                }
            };

            // Garante que o estado inicial do botão "Excluir Selecionados" esteja correto
            updateDeleteSelectedButton();
        });
    </script>
</body>
</html>
